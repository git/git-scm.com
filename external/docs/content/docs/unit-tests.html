---
### DO NOT EDIT! Generated by script/update-docs.rb

category: manual
section: documentation
subsection: manual
title: Git - unit-tests Documentation
docname: unit-tests
version: 2.47.0
latest-changes: 2.47.0
aliases:
- "/docs/unit-tests/index.html"
---
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In our current testing environment, we spend a significant amount of effort
crafting end-to-end tests for error conditions that could easily be captured by
unit tests (or we simply forgo some hard-to-setup and rare error conditions).
Unit tests additionally provide stability to the codebase and can simplify
debugging through isolation. Writing unit tests in pure C, rather than with our
current shell/test-tool helper setup, simplifies test setup, simplifies passing
data around (no shell-isms required), and reduces testing runtime by not
spawning a separate process for every test invocation.</p>
</div>
<div class="paragraph">
<p>We believe that a large body of unit tests, living alongside the existing test
suite, will improve code quality for the Git project.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_definitions"><a class="anchor" href="#_definitions"></a>Definitions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the purposes of this document, we&#8217;ll use <strong>test framework</strong> to refer to
projects that support writing test cases and running tests within the context
of a single executable. <strong>Test harness</strong> will refer to projects that manage
running multiple executables (each of which may contain multiple test cases) and
aggregating their results.</p>
</div>
<div class="paragraph">
<p>In reality, these terms are not strictly defined, and many of the projects
discussed below contain features from both categories.</p>
</div>
<div class="paragraph">
<p>For now, we will evaluate projects solely on their framework features. Since we
are relying on having TAP output (see below), we can assume that any framework
can be made to work with a harness that we can choose later.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We believe the best way forward is to implement a custom TAP framework for the
Git project. We use a version of the framework originally proposed in
<a href="https://lore.kernel.org/git/c902a166-98ce-afba-93f2-ea6027557176@gmail.com/">1</a>.</p>
</div>
<div class="paragraph">
<p>See the <a href="#framework-selection">Framework Selection</a> section below for the
rationale behind this decision.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_choosing_a_test_harness"><a class="anchor" href="#_choosing_a_test_harness"></a>Choosing a test harness</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During upstream discussion, it was occasionally noted that <code>prove</code> provides many
convenient features, such as scheduling slower tests first, or re-running
previously failed tests.</p>
</div>
<div class="paragraph">
<p>While we already support the use of <code>prove</code> as a test harness for the shell
tests, it is not strictly required. The t/Makefile allows running shell tests
directly (though with interleaved output if parallelism is enabled). Git
developers who wish to use <code>prove</code> as a more advanced harness can do so by
setting DEFAULT_TEST_TARGET=prove in their config.mak.</p>
</div>
<div class="paragraph">
<p>We will follow a similar approach for unit tests: by default the test
executables will be run directly from the t/Makefile, but <code>prove</code> can be
configured with DEFAULT_UNIT_TEST_TARGET=prove.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="framework-selection"><a class="anchor" href="#framework-selection"></a>Framework selection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a variety of features we can use to rank the candidate frameworks, and
those features have different priorities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Critical features: we probably won&#8217;t consider a framework without these</p>
<div class="ulist">
<ul>
<li>
<p>Can we legally / easily use the project?</p>
<div class="ulist">
<ul>
<li>
<p><a href="#license">License</a></p>
</li>
<li>
<p><a href="#vendorable-or-ubiquitous">Vendorable or ubiquitous</a></p>
</li>
<li>
<p><a href="#maintainable-extensible">Maintainable / extensible</a></p>
</li>
<li>
<p><a href="#major-platform-support">Major platform support</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Does the project support our bare-minimum needs?</p>
<div class="ulist">
<ul>
<li>
<p><a href="#tap-support">TAP support</a></p>
</li>
<li>
<p><a href="#diagnostic-output">Diagnostic output</a></p>
</li>
<li>
<p><a href="#runtime-skippable-tests">Runtime-skippable tests</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Nice-to-have features:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#parallel-execution">Parallel execution</a></p>
</li>
<li>
<p><a href="#mock-support">Mock support</a></p>
</li>
<li>
<p><a href="#signal-error-handling">Signal &amp; error-handling</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Tie-breaker stats</p>
<div class="ulist">
<ul>
<li>
<p><a href="#project-kloc">Project KLOC</a></p>
</li>
<li>
<p><a href="#adoption">Adoption</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="license"><a class="anchor" href="#license"></a>License</h3>
<div class="paragraph">
<p>We must be able to legally use the framework in connection with Git. As Git is
licensed only under GPLv2, we must eliminate any LGPLv3, GPLv3, or Apache 2.0
projects.</p>
</div>
</div>
<div class="sect2">
<h3 id="vendorable-or-ubiquitous"><a class="anchor" href="#vendorable-or-ubiquitous"></a>Vendorable or ubiquitous</h3>
<div class="paragraph">
<p>We want to avoid forcing Git developers to install new tools just to run unit
tests. Any prospective frameworks and harnesses must either be vendorable
(meaning, we can copy their source directly into Git&#8217;s repository), or so
ubiquitous that it is reasonable to expect that most developers will have the
tools installed already.</p>
</div>
</div>
<div class="sect2">
<h3 id="maintainable-extensible"><a class="anchor" href="#maintainable-extensible"></a>Maintainable / extensible</h3>
<div class="paragraph">
<p>It is unlikely that any pre-existing project perfectly fits our needs, so any
project we select will need to be actively maintained and open to accepting
changes. Alternatively, assuming we are vendoring the source into our repo, it
must be simple enough that Git developers can feel comfortable making changes as
needed to our version.</p>
</div>
<div class="paragraph">
<p>In the comparison table below, "True" means that the framework seems to have
active developers, that it is simple enough that Git developers can make changes
to it, and that the project seems open to accepting external contributions (or
that it is vendorable). "Partial" means that at least one of the above
conditions holds.</p>
</div>
</div>
<div class="sect2">
<h3 id="major-platform-support"><a class="anchor" href="#major-platform-support"></a>Major platform support</h3>
<div class="paragraph">
<p>At a bare minimum, unit-testing must work on Linux, MacOS, and Windows.</p>
</div>
<div class="paragraph">
<p>In the comparison table below, "True" means that it works on all three major
platforms with no issues. "Partial" means that there may be annoyances on one or
more platforms, but it is still usable in principle.</p>
</div>
</div>
<div class="sect2">
<h3 id="tap-support"><a class="anchor" href="#tap-support"></a>TAP support</h3>
<div class="paragraph">
<p>The <a href="https://testanything.org/">Test Anything Protocol</a> is a text-based interface
that allows tests to communicate with a test harness. It is already used by
Git&#8217;s integration test suite. Supporting TAP output is a mandatory feature for
any prospective test framework.</p>
</div>
<div class="paragraph">
<p>In the comparison table below, "True" means this is natively supported.
"Partial" means TAP output must be generated by post-processing the native
output.</p>
</div>
<div class="paragraph">
<p>Frameworks that do not have at least Partial support will not be evaluated
further.</p>
</div>
</div>
<div class="sect2">
<h3 id="diagnostic-output"><a class="anchor" href="#diagnostic-output"></a>Diagnostic output</h3>
<div class="paragraph">
<p>When a test case fails, the framework must generate enough diagnostic output to
help developers find the appropriate test case in source code in order to debug
the failure.</p>
</div>
</div>
<div class="sect2">
<h3 id="runtime-skippable-tests"><a class="anchor" href="#runtime-skippable-tests"></a>Runtime-skippable tests</h3>
<div class="paragraph">
<p>Test authors may wish to skip certain test cases based on runtime circumstances,
so the framework should support this.</p>
</div>
</div>
<div class="sect2">
<h3 id="parallel-execution"><a class="anchor" href="#parallel-execution"></a>Parallel execution</h3>
<div class="paragraph">
<p>Ideally, we will build up a significant collection of unit test cases, most
likely split across multiple executables. It will be necessary to run these
tests in parallel to enable fast develop-test-debug cycles.</p>
</div>
<div class="paragraph">
<p>In the comparison table below, "True" means that individual test cases within a
single test executable can be run in parallel. We assume that executable-level
parallelism can be handled by the test harness.</p>
</div>
</div>
<div class="sect2">
<h3 id="mock-support"><a class="anchor" href="#mock-support"></a>Mock support</h3>
<div class="paragraph">
<p>Unit test authors may wish to test code that interacts with objects that may be
inconvenient to handle in a test (e.g. interacting with a network service).
Mocking allows test authors to provide a fake implementation of these objects
for more convenient tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="signal-error-handling"><a class="anchor" href="#signal-error-handling"></a>Signal &amp; error handling</h3>
<div class="paragraph">
<p>The test framework should fail gracefully when test cases are themselves buggy
or when they are interrupted by signals during runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="project-kloc"><a class="anchor" href="#project-kloc"></a>Project KLOC</h3>
<div class="paragraph">
<p>The size of the project, in thousands of lines of code as measured by
<a href="https://dwheeler.com/sloccount/">sloccount</a> (rounded up to the next multiple of
1,000). As a tie-breaker, we probably prefer a project with fewer LOC.</p>
</div>
</div>
<div class="sect2">
<h3 id="adoption"><a class="anchor" href="#adoption"></a>Adoption</h3>
<div class="paragraph">
<p>As a tie-breaker, we prefer a more widely-used project. We use the number of
GitHub / GitLab stars to estimate this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_comparison"><a class="anchor" href="#_comparison"></a>Comparison</h3>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<colgroup>
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 7.6924%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Framework</th>
<th class="tableblock halign-left valign-top"><a href="#license">License</a></th>
<th class="tableblock halign-left valign-top"><a href="#vendorable-or-ubiquitous">Vendorable or ubiquitous</a></th>
<th class="tableblock halign-left valign-top"><a href="#maintainable-extensible">Maintainable / extensible</a></th>
<th class="tableblock halign-left valign-top"><a href="#major-platform-support">Major platform support</a></th>
<th class="tableblock halign-left valign-top"><a href="#tap-support">TAP support</a></th>
<th class="tableblock halign-left valign-top"><a href="#diagnostic-output">Diagnostic output</a></th>
<th class="tableblock halign-left valign-top"><a href="#runtime&#8212;&#8203;skippable-tests">Runtime- skippable tests</a></th>
<th class="tableblock halign-left valign-top"><a href="#parallel-execution">Parallel execution</a></th>
<th class="tableblock halign-left valign-top"><a href="#mock-support">Mock support</a></th>
<th class="tableblock halign-left valign-top"><a href="#signal-error-handling">Signal &amp; error handling</a></th>
<th class="tableblock halign-left valign-top"><a href="#project-kloc">Project KLOC</a></th>
<th class="tableblock halign-left valign-top"><a href="#adoption">Adoption</a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://lore.kernel.org/git/c902a166-98ce-afba-93f2-ea6027557176@gmail.com/">Custom Git impl.</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#GPL v2#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/silentbicycle/greatest">Greatest</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#ISC#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/Snaipe/Criterion">Criterion</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#MIT#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/rra/c-tap-harness/">C TAP</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#Expat#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://libcheck.github.io/check/">Check</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#LGPL v2.1#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">973</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/clar-test/clar">Clar</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#ISC#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[yellow-background]#Partial#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[red-background]#False#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[lime-background]#True#</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_additional_framework_candidates"><a class="anchor" href="#_additional_framework_candidates"></a>Additional framework candidates</h3>
<div class="paragraph">
<p>Several suggested frameworks have been eliminated from consideration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Incompatible licenses:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/zorgnax/libtap">libtap</a> (LGPL v3)</p>
</li>
<li>
<p><a href="https://cmocka.org/">cmocka</a> (Apache 2.0)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Missing source: <a href="https://www.kindahl.net/mytap/doc/index.html">MyTap</a></p>
</li>
<li>
<p>No TAP support:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://nemequ.github.io/munit/">Âµnit</a></p>
</li>
<li>
<p><a href="https://github.com/google/cmockery">cmockery</a></p>
</li>
<li>
<p><a href="https://github.com/lpabon/cmockery2">cmockery2</a></p>
</li>
<li>
<p><a href="https://github.com/ThrowTheSwitch/Unity">Unity</a></p>
</li>
<li>
<p><a href="https://github.com/siu/minunit">minunit</a></p>
</li>
<li>
<p><a href="https://cunit.sourceforge.net/">CUnit</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_milestones"><a class="anchor" href="#_milestones"></a>Milestones</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Add useful tests of library-like code</p>
</li>
<li>
<p>Integrate with
<a href="https://lore.kernel.org/git/20230502211454.1673000-1-calvinwan@google.com/">stdlib
work</a></p>
</li>
<li>
<p>Run alongside regular <code>make test</code> target</p>
</li>
</ul>
</div>
</div>
</div>