---
### DO NOT EDIT! Generated by script/update-docs.rb

category: manual
section: documentation
subsection: manual
title: Git - pack-heuristics Documentation
docname: pack-heuristics
version: 2.0.5
aliases:
- "/docs/pack-heuristics/2.0.5/index.html"
- "/docs/pack-heuristics/2.1.4/index.html"
- "/docs/pack-heuristics/2.2.3/index.html"
- "/docs/pack-heuristics/2.3.10/index.html"
- "/docs/pack-heuristics/2.4.12/index.html"
- "/docs/pack-heuristics/2.5.6/index.html"
- "/docs/pack-heuristics/2.6.7/index.html"
- "/docs/pack-heuristics/2.7.6/index.html"
- "/docs/pack-heuristics/2.8.6/index.html"
- "/docs/pack-heuristics/2.9.5/index.html"
- "/docs/pack-heuristics/2.10.5/index.html"
- "/docs/pack-heuristics/2.11.4/index.html"
- "/docs/pack-heuristics/2.12.5/index.html"
- "/docs/pack-heuristics/2.13.7/index.html"
- "/docs/pack-heuristics/2.14.6/index.html"
- "/docs/pack-heuristics/2.15.4/index.html"
- "/docs/pack-heuristics/2.16.6/index.html"
- "/docs/pack-heuristics/2.17.0/index.html"
- "/docs/pack-heuristics/2.17.1/index.html"
- "/docs/pack-heuristics/2.17.2/index.html"
- "/docs/pack-heuristics/2.17.3/index.html"
- "/docs/pack-heuristics/2.17.4/index.html"
- "/docs/pack-heuristics/2.17.5/index.html"
- "/docs/pack-heuristics/2.17.6/index.html"
- "/docs/pack-heuristics/2.18.0/index.html"
- "/docs/pack-heuristics/2.18.1/index.html"
- "/docs/pack-heuristics/2.18.2/index.html"
- "/docs/pack-heuristics/2.18.3/index.html"
- "/docs/pack-heuristics/2.18.4/index.html"
- "/docs/pack-heuristics/2.18.5/index.html"
- "/docs/pack-heuristics/2.19.0/index.html"
- "/docs/pack-heuristics/2.19.1/index.html"
- "/docs/pack-heuristics/2.19.2/index.html"
- "/docs/pack-heuristics/2.19.3/index.html"
- "/docs/pack-heuristics/2.19.4/index.html"
- "/docs/pack-heuristics/2.19.5/index.html"
- "/docs/pack-heuristics/2.19.6/index.html"
- "/docs/pack-heuristics/2.20.0/index.html"
- "/docs/pack-heuristics/2.20.1/index.html"
- "/docs/pack-heuristics/2.20.2/index.html"
- "/docs/pack-heuristics/2.20.3/index.html"
- "/docs/pack-heuristics/2.20.4/index.html"
- "/docs/pack-heuristics/2.20.5/index.html"
- "/docs/pack-heuristics/2.21.0/index.html"
- "/docs/pack-heuristics/2.21.1/index.html"
- "/docs/pack-heuristics/2.21.2/index.html"
- "/docs/pack-heuristics/2.21.3/index.html"
- "/docs/pack-heuristics/2.21.4/index.html"
- "/docs/pack-heuristics/2.22.0/index.html"
- "/docs/pack-heuristics/2.22.1/index.html"
- "/docs/pack-heuristics/2.22.2/index.html"
- "/docs/pack-heuristics/2.22.3/index.html"
- "/docs/pack-heuristics/2.22.4/index.html"
- "/docs/pack-heuristics/2.22.5/index.html"
- "/docs/pack-heuristics/2.23.0/index.html"
- "/docs/pack-heuristics/2.23.1/index.html"
- "/docs/pack-heuristics/2.23.2/index.html"
- "/docs/pack-heuristics/2.23.3/index.html"
- "/docs/pack-heuristics/2.23.4/index.html"
- "/docs/pack-heuristics/2.24.0/index.html"
- "/docs/pack-heuristics/2.24.1/index.html"
- "/docs/pack-heuristics/2.24.2/index.html"
- "/docs/pack-heuristics/2.24.3/index.html"
- "/docs/pack-heuristics/2.24.4/index.html"
- "/docs/pack-heuristics/2.25.0/index.html"
- "/docs/pack-heuristics/2.25.1/index.html"
- "/docs/pack-heuristics/2.25.2/index.html"
- "/docs/pack-heuristics/2.25.3/index.html"
- "/docs/pack-heuristics/2.25.4/index.html"
- "/docs/pack-heuristics/2.25.5/index.html"
- "/docs/pack-heuristics/2.26.0/index.html"
- "/docs/pack-heuristics/2.26.1/index.html"
- "/docs/pack-heuristics/2.26.2/index.html"
- "/docs/pack-heuristics/2.26.3/index.html"
- "/docs/pack-heuristics/2.27.0/index.html"
- "/docs/pack-heuristics/2.27.1/index.html"
- "/docs/pack-heuristics/2.28.0/index.html"
- "/docs/pack-heuristics/2.28.1/index.html"
- "/docs/pack-heuristics/2.29.0/index.html"
- "/docs/pack-heuristics/2.29.1/index.html"
- "/docs/pack-heuristics/2.29.2/index.html"
- "/docs/pack-heuristics/2.29.3/index.html"
- "/docs/pack-heuristics/2.30.0/index.html"
- "/docs/pack-heuristics/2.30.1/index.html"
- "/docs/pack-heuristics/2.30.2/index.html"
- "/docs/pack-heuristics/2.30.3/index.html"
- "/docs/pack-heuristics/2.30.4/index.html"
- "/docs/pack-heuristics/2.30.5/index.html"
- "/docs/pack-heuristics/2.30.6/index.html"
- "/docs/pack-heuristics/2.30.7/index.html"
- "/docs/pack-heuristics/2.30.8/index.html"
- "/docs/pack-heuristics/2.30.9/index.html"
- "/docs/pack-heuristics/2.31.0/index.html"
- "/docs/pack-heuristics/2.31.1/index.html"
- "/docs/pack-heuristics/2.31.2/index.html"
- "/docs/pack-heuristics/2.31.3/index.html"
- "/docs/pack-heuristics/2.31.4/index.html"
- "/docs/pack-heuristics/2.31.5/index.html"
- "/docs/pack-heuristics/2.31.6/index.html"
- "/docs/pack-heuristics/2.31.7/index.html"
- "/docs/pack-heuristics/2.31.8/index.html"
- "/docs/pack-heuristics/2.32.0/index.html"
- "/docs/pack-heuristics/2.32.1/index.html"
- "/docs/pack-heuristics/2.32.2/index.html"
- "/docs/pack-heuristics/2.32.3/index.html"
- "/docs/pack-heuristics/2.32.4/index.html"
- "/docs/pack-heuristics/2.32.5/index.html"
- "/docs/pack-heuristics/2.32.6/index.html"
- "/docs/pack-heuristics/2.32.7/index.html"
- "/docs/pack-heuristics/2.33.0/index.html"
- "/docs/pack-heuristics/2.33.1/index.html"
- "/docs/pack-heuristics/2.33.2/index.html"
- "/docs/pack-heuristics/2.33.3/index.html"
- "/docs/pack-heuristics/2.33.4/index.html"
- "/docs/pack-heuristics/2.33.5/index.html"
- "/docs/pack-heuristics/2.33.6/index.html"
- "/docs/pack-heuristics/2.33.7/index.html"
- "/docs/pack-heuristics/2.33.8/index.html"
- "/docs/pack-heuristics/2.34.0/index.html"
- "/docs/pack-heuristics/2.34.1/index.html"
- "/docs/pack-heuristics/2.34.2/index.html"
- "/docs/pack-heuristics/2.34.3/index.html"
- "/docs/pack-heuristics/2.34.4/index.html"
- "/docs/pack-heuristics/2.34.5/index.html"
- "/docs/pack-heuristics/2.34.6/index.html"
- "/docs/pack-heuristics/2.34.7/index.html"
- "/docs/pack-heuristics/2.34.8/index.html"
- "/docs/pack-heuristics/2.35.0/index.html"
- "/docs/pack-heuristics/2.35.1/index.html"
- "/docs/pack-heuristics/2.35.2/index.html"
- "/docs/pack-heuristics/2.35.3/index.html"
- "/docs/pack-heuristics/2.35.4/index.html"
- "/docs/pack-heuristics/2.35.5/index.html"
- "/docs/pack-heuristics/2.35.6/index.html"
- "/docs/pack-heuristics/2.35.7/index.html"
- "/docs/pack-heuristics/2.35.8/index.html"
- "/docs/pack-heuristics/2.36.0/index.html"
- "/docs/pack-heuristics/2.36.1/index.html"
- "/docs/pack-heuristics/2.36.2/index.html"
- "/docs/pack-heuristics/2.36.3/index.html"
- "/docs/pack-heuristics/2.36.4/index.html"
- "/docs/pack-heuristics/2.36.5/index.html"
- "/docs/pack-heuristics/2.36.6/index.html"
- "/docs/pack-heuristics/2.37.0/index.html"
- "/docs/pack-heuristics/2.37.1/index.html"
- "/docs/pack-heuristics/2.37.2/index.html"
- "/docs/pack-heuristics/2.37.3/index.html"
- "/docs/pack-heuristics/2.37.4/index.html"
- "/docs/pack-heuristics/2.37.5/index.html"
- "/docs/pack-heuristics/2.37.6/index.html"
- "/docs/pack-heuristics/2.37.7/index.html"
- "/docs/pack-heuristics/2.38.0/index.html"
- "/docs/pack-heuristics/2.38.1/index.html"
- "/docs/pack-heuristics/2.38.2/index.html"
- "/docs/pack-heuristics/2.38.3/index.html"
- "/docs/pack-heuristics/2.38.4/index.html"
- "/docs/pack-heuristics/2.38.5/index.html"
- "/docs/pack-heuristics/2.39.0/index.html"
- "/docs/pack-heuristics/2.39.1/index.html"
- "/docs/pack-heuristics/2.39.2/index.html"
- "/docs/pack-heuristics/2.39.3/index.html"
- "/docs/pack-heuristics/2.39.4/index.html"
- "/docs/pack-heuristics/2.39.5/index.html"
- "/docs/pack-heuristics/2.40.0/index.html"
- "/docs/pack-heuristics/2.40.1/index.html"
- "/docs/pack-heuristics/2.40.2/index.html"
- "/docs/pack-heuristics/2.40.3/index.html"
- "/docs/pack-heuristics/2.41.0/index.html"
- "/docs/pack-heuristics/2.41.1/index.html"
- "/docs/pack-heuristics/2.41.2/index.html"
- "/docs/pack-heuristics/2.42.0/index.html"
- "/docs/pack-heuristics/2.42.1/index.html"
- "/docs/pack-heuristics/2.42.2/index.html"
- "/docs/pack-heuristics/2.42.3/index.html"
- "/docs/pack-heuristics/2.43.0/index.html"
- "/docs/pack-heuristics/2.43.1/index.html"
- "/docs/pack-heuristics/2.43.2/index.html"
- "/docs/pack-heuristics/2.43.3/index.html"
- "/docs/pack-heuristics/2.43.4/index.html"
- "/docs/pack-heuristics/2.43.5/index.html"
- "/docs/pack-heuristics/2.44.0/index.html"
- "/docs/pack-heuristics/2.44.1/index.html"
- "/docs/pack-heuristics/2.44.2/index.html"
- "/docs/pack-heuristics/2.45.0/index.html"
- "/docs/pack-heuristics/2.45.1/index.html"
- "/docs/pack-heuristics/2.45.2/index.html"
- "/docs/pack-heuristics/2.46.0/index.html"
- "/docs/pack-heuristics/2.46.1/index.html"
- "/docs/pack-heuristics/2.46.2/index.html"
- "/docs/pack-heuristics/2.47.0/index.html"
---
<div id="preamble">
<div class="sectionbody">
<div class="literalblock">
<div class="content">
<pre>Oh, here's a really stupid question:</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>             Where do I go
          to learn the details
of Git's packing heuristics?</pre>
</div>
</div>
<div class="paragraph">
<p>Be careful what you ask!</p>
</div>
<div class="paragraph">
<p>Followers of the Git, please open the Git IRC Log and turn to
February 10, 2006.</p>
</div>
<div class="paragraph">
<p>It&#8217;s a rare occasion, and we are joined by the King Git Himself,
Linus Torvalds (linus).  Nathaniel Smith, (njs`), has the floor
and seeks enlightenment.  Others are present, but silent.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s listen in!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;njs`&gt; Oh, here's a really stupid question -- where do I go to
learn the details of Git's packing heuristics?  google avails
       me not, reading the source didn't help a lot, and wading
       through the whole mailing list seems less efficient than any
       of that.</pre>
</div>
</div>
<div class="paragraph">
<p>It is a bold start!  A plea for help combined with a simultaneous
tri-part attack on some of the tried and true mainstays in the quest
for enlightenment.  Brash accusations of google being useless. Hubris!
Maligning the source.  Heresy!  Disdain for the mailing list archives.
Woe.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;pasky&gt; yes, the packing-related delta stuff is somewhat
    mysterious even for me ;)</pre>
</div>
</div>
<div class="paragraph">
<p>Ah!  Modesty after all.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  &lt;linus&gt; njs, I don't think the docs exist. That's something where
I don't think anybody else than me even really got involved.
Most of the rest of Git others have been busy with (especially
Junio), but packing nobody touched after I did it.</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s cryptic, yet vague.  Linus in style for sure.  Wise men
interpret this as an apology.  A few argue it is merely a
statement of fact.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; I guess the next step is "read the source again", but I
    have to build up a certain level of gumption first :-)</pre>
</div>
</div>
<div class="paragraph">
<p>Indeed!  On both points.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; The packing heuristic is actually really really simple.</pre>
</div>
</div>
<div class="paragraph">
<p>Bait&#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; But strange.</pre>
</div>
</div>
<div class="paragraph">
<p>And switch.  That ought to do it!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Remember: Git really doesn't follow files. So what it does is
    - generate a list of all objects
    - sort the list according to magic heuristics
    - walk the list, using a sliding window, seeing if an object
      can be diffed against another object in the window
    - write out the list in recency order</pre>
</div>
</div>
<div class="paragraph">
<p>The traditional understatement:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; I suspect that what I'm missing is the precise definition of
    the word "magic"</pre>
</div>
</div>
<div class="paragraph">
<p>The traditional insight:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;pasky&gt; yes</pre>
</div>
</div>
<div class="paragraph">
<p>And Babel-like confusion flowed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; oh, hmm, and I'm not sure what this sliding window means either</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;pasky&gt; iirc, it appeared to me to be just the sha1 of the object
    when reading the code casually ...</pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>which simply doesn&#8217;t sound as a very good heuristics, though ;)</p>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; .....and recency order.  okay, I think it's clear I didn't
   even realize how much I wasn't realizing :-)</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ah, grasshopper!  And thus the enlightenment begins anew.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;linus&gt; The "magic" is actually in theory totally arbitrary.
       ANY order will give you a working pack, but no, it's not
ordered by SHA-1.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Before talking about the ordering for the sliding delta
window, let's talk about the recency order. That's more
important in one way.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Right, but if all you want is a working way to pack things
    together, you could just use cat and save yourself some
    trouble...</pre>
</div>
</div>
<div class="paragraph">
<p>Waaait for it&#8230;&#8203;.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; The recency ordering (which is basically: put objects
    _physically_ into the pack in the order that they are
    "reachable" from the head) is important.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; okay</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; It's important because that's the thing that gives packs
    good locality. It keeps the objects close to the head (whether
    they are old or new, but they are _reachable_ from the head)
    at the head of the pack. So packs actually have absolutely
    _wonderful_ IO patterns.</pre>
</div>
</div>
<div class="paragraph">
<p>Read that again, because it is important.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; But recency ordering is totally useless for deciding how
    to actually generate the deltas, so the delta ordering is
    something else.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>The delta ordering is (wait for it):
- first sort by the "basename" of the object, as defined by
  the name the object was _first_ reached through when
  generating the object list
- within the same basename, sort by size of the object
- but always sort different types separately (commits first).</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>That's not exactly it, but it's very close.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; The "_first_ reached" thing is not too important, just you
    need some way to break ties since the same objects may be
    reachable many ways, yes?</pre>
</div>
</div>
<div class="paragraph">
<p>And as if to clarify:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; The point is that it's all really just any random
    heuristic, and the ordering is totally unimportant for
    correctness, but it helps a lot if the heuristic gives
    "clumping" for things that are likely to delta well against
    each other.</pre>
</div>
</div>
<div class="paragraph">
<p>It is an important point, so secretly, I did my own research and have
included my results below.  To be fair, it has changed some over time.
And through the magic of Revisionistic History, I draw upon this entry
from The Git IRC Logs on my father&#8217;s birthday, March 1:</p>
</div>
<div class="literalblock">
<div class="content">
<pre> &lt;gitster&gt; The quote from the above linus should be rewritten a
     bit (wait for it):
     - first sort by type.  Different objects never delta with
each other.
     - then sort by filename/dirname.  hash of the basename
       occupies the top BITS_PER_INT-DIR_BITS bits, and bottom
       DIR_BITS are for the hash of leading path elements.
     - then if we are doing "thin" pack, the objects we are _not_
       going to pack but we know about are sorted earlier than
       other objects.
     - and finally sort by size, larger to smaller.</pre>
</div>
</div>
<div class="paragraph">
<p>In one swell-foop, clarification and obscurification!  Nonetheless,
authoritative.  Cryptic, yet concise.  It even solicits notions of
quotes from The Source Code.  Clearly, more study is needed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;gitster&gt; That's the sort order.  What this means is:
       - we do not delta different object types.
- we prefer to delta the objects with the same full path, but
         allow files with the same name from different directories.
- we always prefer to delta against objects we are not going
         to send, if there are some.
- we prefer to delta against larger objects, so that we have
         lots of removals.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>The penultimate rule is for "thin" packs.  It is used when
the other side is known to have such objects.</pre>
</div>
</div>
<div class="paragraph">
<p>There it is again. "Thin" packs.  I&#8217;m thinking to myself, "What
is a <em>thin</em> pack?"  So I ask:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;jdl&gt; What is a "thin" pack?</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;gitster&gt; Use of --objects-edge to rev-list as the upstream of
    pack-objects.  The pack transfer protocol negotiates that.</pre>
</div>
</div>
<div class="paragraph">
<p>Woo hoo!  Cleared that <em>right</em> up!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;gitster&gt; There are two directions - push and fetch.</pre>
</div>
</div>
<div class="paragraph">
<p>There!  Did you see it?  It is not <em>"push" and "pull"</em>!  How often the
confusion has started here.  So casually mentioned, too!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;gitster&gt; For push, git-send-pack invokes git-receive-pack on the
    other end.  The receive-pack says "I have up to these commits".
    send-pack looks at them, and computes what are missing from
    the other end.  So "thin" could be the default there.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>       In the other direction, fetch, git-fetch-pack and
       git-clone-pack invokes git-upload-pack on the other end
(via ssh or by talking to the daemon).</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>There are two cases: fetch-pack with -k and clone-pack is one,
       fetch-pack without -k is the other.  clone-pack and fetch-pack
       with -k will keep the downloaded packfile without expanded, so
       we do not use thin pack transfer.  Otherwise, the generated
       pack will have delta without base object in the same pack.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>But fetch-pack without -k will explode the received pack into
individual objects, so we automatically ask upload-pack to
give us a thin pack if upload-pack supports it.</pre>
</div>
</div>
<div class="paragraph">
<p>OK then.</p>
</div>
<div class="paragraph">
<p>Uh.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s return to the previous conversation still in progress.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; and "basename" means something like "the tail of end of
    path of file objects and dir objects, as per basename(3), and
    we just declare all commit and tag objects to have the same
    basename" or something?</pre>
</div>
</div>
<div class="paragraph">
<p>Luckily, that too is a point that gitster clarified for us!</p>
</div>
<div class="paragraph">
<p>If I might add, the trick is to make files that <em>might</em> be similar be
located close to each other in the hash buckets based on their file
names.  It used to be that "foo/Makefile", "bar/baz/quux/Makefile" and
"Makefile" all landed in the same bucket due to their common basename,
"Makefile". However, now they land in "close" buckets.</p>
</div>
<div class="paragraph">
<p>The algorithm allows not just for the <em>same</em> bucket, but for <em>close</em>
buckets to be considered delta candidates.  The rationale is
essentially that files, like Makefiles, often have very similar
content no matter what directory they live in.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; I played around with different delta algorithms, and with
    making the "delta window" bigger, but having too big of a
    sliding window makes it very expensive to generate the pack:
    you need to compare every object with a _ton_ of other objects.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>There are a number of other trivial heuristics too, which
basically boil down to "don't bother even trying to delta this
pair" if we can tell before-hand that the delta isn't worth it
(due to size differences, where we can take a previous delta
result into account to decide that "ok, no point in trying
that one, it will be worse").</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>End result: packing is actually very size efficient. It's
somewhat CPU-wasteful, but on the other hand, since you're
really only supposed to do it maybe once a month (and you can
do it during the night), nobody really seems to care.</pre>
</div>
</div>
<div class="paragraph">
<p>Nice Engineering Touch, there.  Find when it doesn&#8217;t matter, and
proclaim it a non-issue.  Good style too!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; So, just to repeat to see if I'm following, we start by
    getting a list of the objects we want to pack, we sort it by
    this heuristic (basically lexicographically on the tuple
    (type, basename, size)).</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Then we walk through this list, and calculate a delta of
each object against the last n (tunable parameter) objects,
and pick the smallest of these deltas.</pre>
</div>
</div>
<div class="paragraph">
<p>Vastly simplified, but the essence is there!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Correct.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; And then once we have picked a delta or fulltext to
    represent each object, we re-sort by recency, and write them
    out in that order.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Yup. Some other small details:</pre>
</div>
</div>
<div class="paragraph">
<p>And of course there is the "Other Shoe" Factor too.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; - We limit the delta depth to another magic value (right
    now both the window and delta depth magic values are just "10")</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Hrm, my intuition is that you'd end up with really _bad_ IO
    patterns, because the things you want are near by, but to
    actually reconstruct them you may have to jump all over in
    random ways.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; - When we write out a delta, and we haven't yet written
    out the object it is a delta against, we write out the base
    object first.  And no, when we reconstruct them, we actually
    get nice IO patterns, because:
    - larger objects tend to be "more recent" (Linus' law: files grow)
    - we actively try to generate deltas from a larger object to a
      smaller one
    - this means that the top-of-tree very seldom has deltas
      (i.e. deltas in _practice_ are "backwards deltas")</pre>
</div>
</div>
<div class="paragraph">
<p>Again, we should reread that whole paragraph.  Not just because
Linus has slipped Linus&#8217;s Law in there on us, but because it is
important.  Let&#8217;s make sure we clarify some of the points here:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; So the point is just that in practice, delta order and
    recency order match each other quite well.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;linus&gt; Yes. There's another nice side to this (and yes, it was
designed that way ;):
       - the reason we generate deltas against the larger object is
  actually a big space saver too!</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Hmm, but your last comment (if "we haven't yet written out
    the object it is a delta against, we write out the base object
    first"), seems like it would make these facts mostly
    irrelevant because even if in practice you would not have to
    wander around much, in fact you just brute-force say that in
    the cases where you might have to wander, don't do that :-)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Yes and no. Notice the rule: we only write out the base
    object first if the delta against it was more recent.  That
    means that you can actually have deltas that refer to a base
    object that is _not_ close to the delta object, but that only
    happens when the delta is needed to generate an _old_ object.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; See?</pre>
</div>
</div>
<div class="paragraph">
<p>Yeah, no.  I missed that on the first two or three readings myself.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; This keeps the front of the pack dense. The front of the
    pack never contains data that isn't relevant to a "recent"
    object.  The size optimization comes from our use of xdelta
    (but is true for many other delta algorithms): removing data
    is cheaper (in size) than adding data.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>       When you remove data, you only need to say "copy bytes n--m".
In contrast, in a delta that _adds_ data, you have to say "add
       these bytes: 'actual data goes here'"</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>njs` has quit: Read error: 104 (Connection reset by peer)</p>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Uhhuh. I hope I didn't blow njs` mind.</pre>
</div>
</div>
</li>
<li>
<p>njs` has joined channel #git</p>
<div class="literalblock">
<div class="content">
<pre>&lt;pasky&gt; :)</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The silent observers are amused.  Of course.</p>
</div>
<div class="paragraph">
<p>And as if njs` was expected to be omniscient:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; njs - did you miss anything?</pre>
</div>
</div>
<div class="paragraph">
<p>OK, I&#8217;ll spell it out.  That&#8217;s Geek Humor.  If njs` was not actually
connected for a little bit there, how would he know if missed anything
while he was disconnected?  He&#8217;s a benevolent dictator with a sense of
humor!  Well noted!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Stupid router.  Or gremlins, or whatever.</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a cheap shot at Cisco.  Take 'em when you can.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Yes and no. Notice the rule: we only write out the base
    object first if the delta against it was more recent.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>       I'm getting lost in all these orders, let me re-read :-)
So the write-out order is from most recent to least recent?
       (Conceivably it could be the opposite way too, I'm not sure if
       we've said) though my connection back at home is logging, so I
       can just read what you said there :-)</pre>
</div>
</div>
<div class="paragraph">
<p>And for those of you paying attention, the Omniscient Trick has just
been detailed!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Yes, we always write out most recent first</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; And, yeah, I got the part about deeper-in-history stuff
    having worse IO characteristics, one sort of doesn't care.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; With the caveat that if the "most recent" needs an older
    object to delta against (hey, shrinking sometimes does
    happen), we write out the old object with the delta.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; (if only it happened more...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;linus&gt; Anyway, the pack-file could easily be denser still, but
because it's used both for streaming (the Git protocol) and
       for on-disk, it has a few pessimizations.</pre>
</div>
</div>
<div class="paragraph">
<p>Actually, it is a made-up word. But it is a made-up word being
used as setup for a later optimization, which is a real word:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; In particular, while the pack-file is then compressed,
    it's compressed just one object at a time, so the actual
    compression factor is less than it could be in theory. But it
    means that it's all nice random-access with a simple index to
    do "object name-&gt;location in packfile" translation.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; I'm assuming the real win for delta-ing large-&gt;small is
    more homogeneous statistics for gzip to run over?</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(You have to put the bytes in one place or another, but
putting them in a larger blob wins on compression)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Actually, what is the compression strategy -- each delta
individually gzipped, the whole file gzipped, somewhere in
between, no compression at all, ....?</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Right.</pre>
</div>
</div>
<div class="paragraph">
<p>Reality IRC sets in.  For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;pasky&gt; I'll read the rest in the morning, I really have to go
    sleep or there's no hope whatsoever for me at the today's
    exam... g'nite all.</pre>
</div>
</div>
<div class="paragraph">
<p>Heh.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; pasky: g'nite</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; pasky: 'luck</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Right: large-&gt;small matters exactly because of compression
    behaviour. If it was non-compressed, it probably wouldn't make
    any difference.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; yeah</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; Anyway: I'm not even trying to claim that the pack-files
    are perfect, but they do tend to have a nice balance of
    density vs ease-of use.</pre>
</div>
</div>
<div class="paragraph">
<p>Gasp!  OK, saved.  That&#8217;s a fair Engineering trade off.  Close call!
In fact, Linus reflects on some Basic Engineering Fundamentals,
design options, etc.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;linus&gt; More importantly, they allow Git to still _conceptually_
    never deal with deltas at all, and be a "whole object" store.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>       Which has some problems (we discussed bad huge-file
behaviour on the Git lists the other day), but it does mean
that the basic Git concepts are really really simple and
       straightforward.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>It's all been quite stable.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Which I think is very much a result of having very simple
basic ideas, so that there's never any confusion about what's
going on.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Bugs happen, but they are "simple" bugs. And bugs that
actually get some object store detail wrong are almost always
so obvious that they never go anywhere.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; Yeah.</pre>
</div>
</div>
<div class="paragraph">
<p>Nuff said.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  &lt;linus&gt; Anyway.  I'm off for bed. It's not 6AM here, but I've got
three kids, and have to get up early in the morning to send
them off. I need my beauty sleep.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;njs`&gt; :-)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>   &lt;njs`&gt; appreciate the infodump, I really was failing to find the
details on Git packs :-)</pre>
</div>
</div>
<div class="paragraph">
<p>And now you know the rest of the story.</p>
</div>
</div>
</div>